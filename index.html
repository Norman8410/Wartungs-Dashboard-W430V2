<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Agie Wartung - Cloud Sync</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Behalte dein bisheriges CSS hier bei oder nutze dieses kompakte Setup */
        .top-bar { height: 8px; width: 100%; background: linear-gradient(90deg, #d50000, #003a6c, #00b5e2); position: fixed; top: 0; left: 0; z-index: 1000; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; margin: 0; padding: 25px; padding-top: 40px; display: flex; flex-direction: column; align-items: center; }
        .main-layout { display: flex; width: 98%; max-width: 1600px; gap: 20px; }
        .chart-container { flex: 3; background: white; padding: 20px; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sidebar { flex: 1.5; background: #fff; padding: 15px; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto; }
        .control-row { display: flex; align-items: center; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 5px solid #eee; background: #f9f9f9; }
        .status-red { border-left-color: #d50000; background: #ffcccc; }
        .btn { width: 30px; height: 30px; cursor: pointer; border: none; color: white; border-radius: 3px; font-weight: bold; }
        .btn-plus { background: #00b5e2; } .btn-minus { background: #003a6c; } .btn-wplan { background: #d50000; font-size: 10px; }
    </style>
</head>
<body>
    <div class="top-bar"></div>
    <h2>Agie Wartung <span id="sync-status" style="font-size: 0.5em; color: green;">● Online</span></h2>
    
    <div style="margin-bottom: 15px;">
        <button onclick="document.getElementById('fileInput').click()">JSON laden</button>
        <button onclick="exportHistory()">Historie CSV</button>
    </div>
    <input type="file" id="fileInput" accept=".json" style="display:none">

    <div class="main-layout">
        <div class="chart-container"><canvas id="myChart"></canvas></div>
        <div class="sidebar" id="controlsList"></div>
    </div>

    <script>
        // --- DEINE FIREBASE KONFIGURATION HIER EINTRAGEN ---
        const firebaseConfig = {
            apiKey: "DEIN_API_KEY",
            authDomain: "DEIN_PROJEKT.firebaseapp.com",
            databaseURL: "https://DEIN_PROJEKT-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "DEIN_PROJEKT",
            storageBucket: "DEIN_PROJEKT.appspot.com",
            messagingSenderId: "DEINE_ID",
            appId: "DEINE_APP_ID"
        };
        // --------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        Chart.register(ChartDataLabels);

        let myChart, rawData = [];
        let state = { extraCycles: {}, agieOffsets: {}, history: [], triggeredNegatives: {} };
        const INTERVALL = 16000, RESET_VAL = 216000, PW_UNDO = "87430";
        const packages = ["P1/2", "P1/3", "P1/2", "P1/4", "P1/2/3", "P1/5", "P1/2", "P1/3", "P1/2", "P1/4", "P1/2/3", "P1/6/7", "P1/2"];

        // Daten aus Cloud laden
        db.ref('maintenanceState').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                state = {
                    extraCycles: data.extraCycles || {},
                    agieOffsets: data.agieOffsets || {},
                    history: data.history || [],
                    triggeredNegatives: data.triggeredNegatives || {}
                };
                updateDisplay();
            }
        });

        async function saveToCloud() {
            document.getElementById('sync-status').style.color = 'orange';
            await db.ref('maintenanceState').set(state);
            document.getElementById('sync-status').style.color = 'green';
        }

        function logEvent(agie, eventType, count, totalStueck) {
            state.history.push({ Zeitstempel: new Date().toLocaleString('de-DE'), Agie: agie, Ereignis: eventType, Zaehler: count, Gesamtstueck: totalStueck });
            saveToCloud();
        }

        function updateDisplay() {
            if (rawData.length === 0) return;
            const processed = rawData.map(item => {
                const id = item.StationNo, ist = Number(item.Parts);
                const korrIst = ist - (state.agieOffsets[id] || 0);
                const count = (state.extraCycles[id] || 0);
                const diff = (INTERVALL + (count * INTERVALL)) - korrIst;

                if (diff < 0 && !state.triggeredNegatives[id + "_" + (state.agieOffsets[id] || 0) + "_" + count]) {
                    logEvent(id, "Limit erreicht", count, ist);
                    state.triggeredNegatives[id + "_" + (state.agieOffsets[id] || 0) + "_" + count] = true;
                    saveToCloud();
                }
                return { label: "Agie "+id, id, diff, ist: korrIst, count, rawIst: ist, packageName: packages[count % 13] };
            });

            processed.sort((a, b) => a.diff - b.diff);
            renderChart(processed);
            renderControls(processed);
        }

        function renderControls(data) {
            const container = document.getElementById('controlsList');
            container.innerHTML = "";
            data.forEach(d => {
                const row = document.createElement('div');
                row.className = `control-row ${d.diff < 500 ? 'status-red' : ''}`;
                row.innerHTML = `
                    <div style="flex:1"><strong>A${d.id}</strong><br><small>${d.packageName}</small></div>
                    <div style="flex:1; font-weight:bold">${d.diff.toLocaleString()}</div>
                    <button class="btn btn-wplan" onclick="wPlanReset('${d.id}')">WP</button>
                    <button class="btn btn-minus" onclick="changeCount('${d.id}', -1, ${d.rawIst})">-</button>
                    <span style="width:20px; text-align:center">${d.count}</span>
                    <button class="btn btn-plus" onclick="changeCount('${d.id}', 1, ${d.rawIst})">+</button>
                `;
                container.appendChild(row);
            });
        }

        function changeCount(id, delta, rawIst) {
            state.extraCycles[id] = Math.max(0, (state.extraCycles[id] || 0) + delta);
            logEvent(id, delta > 0 ? "Wartung +" : "Korrektur -", state.extraCycles[id], rawIst);
        }

        function wPlanReset(id) {
            if(confirm("Großer Wartungsplan-Reset?")) {
                state.agieOffsets[id] = (state.agieOffsets[id] || 0) + RESET_VAL;
                state.extraCycles[id] = 0;
                logEvent(id, "WPlan Reset", 0, "N/A");
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{ data: data.map(d => d.diff), backgroundColor: '#003a6c' }]
                },
                options: { plugins: { legend: false, datalabels: { anchor: 'end', align: 'top', rotation: -90 } } }
            });
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const r = new FileReader();
            r.onload = ev => { rawData = JSON.parse(ev.target.result); updateDisplay(); };
            r.readAsText(e.target.files[0]);
        });

        function exportHistory() {
            let csv = "\uFEFFZeitstempel;Agie;Ereignis;Zaehler;Gesamtstueck\n";
            state.history.forEach(r => csv += `${r.Zeitstempel};${r.Agie};${r.Ereignis};${r.Zaehler};${r.Gesamtstueck}\n`);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            link.download = "Wartung_Cloud.csv";
            link.click();
        }
    </script>
</body>
</html>
