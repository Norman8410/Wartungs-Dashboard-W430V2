<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Agie Wartung - Bosch Authentication</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        .top-bar { height: 8px; width: 100%; background: linear-gradient(90deg, #d50000 25%, #003a6c 25%, #003a6c 50%, #00b5e2 50%, #00b5e2 75%, #008a4f 75%); position: fixed; top: 0; left: 0; z-index: 1000; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #eff1f2; margin: 0; padding: 20px; padding-top: 50px; display: flex; flex-direction: column; align-items: center; }
        
        /* Auth Screens */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #eff1f2; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 30px; border-top: 6px solid #d50000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 380px; text-align: center; }
        .auth-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #bfc0c2; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; background: #003a6c; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .toggle-link { color: #00b5e2; cursor: pointer; font-size: 0.85em; text-decoration: underline; margin-top: 15px; display: inline-block; }

        /* Dashboard Styles */
        .header { display: flex; flex-direction: column; width: 98%; max-width: 1600px; background: white; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .bosch-brand { color: #d50000; font-weight: 900; font-size: 24px; letter-spacing: -1px; }
        .bosch-brand span { color: #003a6c; }
        
        .main-layout { display: flex; width: 98%; max-width: 1600px; gap: 20px; display: none; } /* Hidden until login */
        .chart-container { background: white; padding: 20px; border-top: 4px solid #003a6c; flex: 3; min-height: 400px; }
        .sidebar { flex: 1.5; background: white; padding: 15px; border-top: 4px solid #00b5e2; height: 80vh; overflow-y: auto; }
        
        .tracking-container { background: white; padding: 15px; margin-top: 20px; border-top: 4px solid #bfc0c2; }
        .tracking-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .tracking-table th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; }
        
        .control-row { display: flex; align-items: center; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; gap: 10px; }
        .btn { width: 32px; height: 32px; cursor: pointer; border: none; color: white; font-weight: bold; }
        .btn-plus { background: #00b5e2; } .btn-minus { background: #003a6c; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-box" id="login-form">
            <div class="bosch-brand">BOSCH<span> AGIE</span></div>
            <p>Bitte anmelden</p>
            <input type="email" id="login-email" placeholder="E-Mail (z.B. mueller@bosch.de)">
            <input type="password" id="login-pass" placeholder="Passwort">
            <button class="auth-btn" onclick="handleLogin()">Einloggen</button>
            <span class="toggle-link" onclick="showRegister(true)">Neuen Account registrieren</span>
        </div>

        <div class="auth-box" id="register-form" style="display:none">
            <div class="bosch-brand">BOSCH<span> AGIE</span></div>
            <p>Registrierung</p>
            <input type="text" id="reg-name" placeholder="Dein Name (für das Tracking)">
            <input type="email" id="reg-email" placeholder="E-Mail">
            <input type="password" id="reg-pass" placeholder="Eigenes Passwort (min. 6 Zeichen)">
            <hr>
            <input type="password" id="reg-invite" placeholder="Einladungs-Code (bosch2026)" style="border: 2px solid #00b5e2">
            <button class="auth-btn" style="background:#00b5e2" onclick="handleRegister()">Account erstellen</button>
            <span class="toggle-link" onclick="showRegister(false)">Zurück zum Login</span>
        </div>
    </div>

    <div class="top-bar"></div>
    <div class="header">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <div class="bosch-brand">BOSCH<span> AGIE</span></div>
            <div>
                <span id="user-display" style="font-weight:bold; color:#003a6c"></span>
                <button onclick="handleLogout()" style="margin-left:15px; cursor:pointer">Logout</button>
            </div>
        </div>
    </div>

    <div class="main-layout" id="dashboard">
        <div style="flex: 3;">
            <div class="chart-container"><canvas id="myChart"></canvas></div>
            <div class="tracking-container">
                <div style="font-weight:bold; color:#003a6c; margin-bottom:10px">LETZTE AKTIVITÄTEN</div>
                <table class="tracking-table">
                    <thead><tr><th>Zeit</th><th>Agie</th><th>Aktion</th><th>Benutzer</th></tr></thead>
                    <tbody id="tracking-body"></tbody>
                </table>
            </div>
        </div>
        <div class="sidebar" id="controlsList"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg",
            authDomain: "bosch-agie-wartung.firebaseapp.com",
            databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bosch-agie-wartung",
            storageBucket: "bosch-agie-wartung.firebasestorage.app",
            messagingSenderId: "211606405555",
            appId: "1:211606405555:web:cc2475ca47804086a3cbc6"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- AUTH LOGIC ---
        function showRegister(show) {
            document.getElementById('login-form').style.display = show ? 'none' : 'block';
            document.getElementById('register-form').style.display = show ? 'block' : 'none';
        }

        function handleRegister() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const invite = document.getElementById('reg-invite').value;

            if (invite !== "bosch2026") return alert("Falscher Einladungs-Code!");
            if (!name || pass.length < 6) return alert("Name fehlt oder Passwort zu kurz (min 6 Zeichen)!");

            auth.createUserWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    return userCredential.user.updateProfile({ displayName: name });
                })
                .catch(error => alert("Fehler: " + error.message));
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(email, pass).catch(error => alert("Fehler: " + error.message));
        }

        function handleLogout() { auth.signOut(); location.reload(); }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                document.getElementById('user-display').innerText = "Angemeldet als: " + user.displayName;
                initDashboard();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        // --- DASHBOARD LOGIC ---
        let state = { extraCycles: {}, agieOffsets: {}, history: [], cloudRawData: [] };
        const INTERVALL = 16000;

        function initDashboard() {
            db.ref('maintenanceState').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state = data;
                    updateUI();
                }
            });
        }

        function updateUI() {
            // Tracking Tabelle
            const body = document.getElementById('tracking-body');
            body.innerHTML = "";
            const logs = state.history ? [...state.history].reverse().slice(0, 8) : [];
            logs.forEach(log => {
                body.innerHTML += `<tr><td>${log.Zeitstempel}</td><td>A${log.Agie}</td><td>${log.Ereignis}</td><td>${log.Benutzer}</td></tr>`;
            });
            // Hier käme der Code für Chart & Controls (wie zuvor)
        }

        async function logAction(agieId, event) {
            const zeit = new Date().toLocaleString('de-DE');
            if(!state.history) state.history = [];
            state.history.push({
                Zeitstempel: zeit,
                Agie: agieId,
                Ereignis: event,
                Benutzer: auth.currentUser.displayName
            });
            await db.ref('maintenanceState').update(state);
        }
    </script>
</body>
</html>
