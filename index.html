<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Agie Wartung - Bosch V9.9.2 Final Fix</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        :root { 
            --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-light-blue: #00b5e2; 
            --bosch-green: #008a4f; --bosch-gray: #eff1f2; --text-dark: #333;
        }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 8px; width: 100%; background: linear-gradient(90deg, var(--bosch-red) 25%, var(--bosch-blue) 25%, var(--bosch-blue) 50%, var(--bosch-light-blue) 50%, var(--bosch-light-blue) 75%, var(--bosch-green) 75%); flex-shrink: 0; }
        .header { background: white; padding: 12px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .bosch-brand { color: var(--bosch-red); font-weight: 900; font-size: 24px; letter-spacing: -0.5px; }
        .bosch-brand span { color: var(--bosch-blue); }
        .action-bar { padding: 10px 30px; display: flex; gap: 12px; align-items: center; background: var(--bosch-gray); }
        .nav-btn { padding: 8px 16px; cursor: pointer; border: 1px solid #bfc0c2; background: white; font-weight: 700; color: var(--bosch-blue); border-radius: 2px; }
        .btn-primary { background: var(--bosch-blue); color: white; border-color: var(--bosch-blue); }

        .main-layout { display: flex; flex: 1; padding: 10px 30px 20px 30px; gap: 20px; overflow: hidden; }
        .content-area { flex: 3; display: flex; flex-direction: column; gap: 15px; position: relative; }
        .sidebar { flex: 1.2; background: white; border-top: 4px solid var(--bosch-light-blue); overflow-y: auto; max-width: 450px; }
        .chart-container { background: white; padding: 15px; border-top: 4px solid var(--bosch-blue); flex: 1; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Der PrÃ¤sentations Button */
        #btnShowPresentation { 
            position: absolute; bottom: 20px; right: 20px; z-index: 100; 
            display: none; background: var(--bosch-green); color: white; 
            border: none; padding: 12px 20px; border-radius: 4px; 
            cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* PPT Styles */
        .ppt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .ppt-slide { background: white; width: 80%; height: 70%; padding: 50px; border-radius: 4px; display: none; flex-direction: column; position: relative; border-top: 8px solid var(--bosch-red); }
        .ppt-slide.active { display: flex; }
        .ppt-header { color: var(--bosch-blue); font-size: 32px; font-weight: 900; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .ppt-content { font-size: 20px; line-height: 1.6; color: #333; }
        .ppt-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }

        /* Button Styling in der Liste */
        .control-row { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; border-left: 6px solid #ccc; gap: 8px; }
        .btn-icon { width: 34px; height: 34px; cursor: pointer; border: none; color: white; font-weight: bold; border-radius: 4px; }
        .btn-icon:disabled { background-color: #e0e0e0 !important; color: #aaa !important; cursor: not-allowed; opacity: 0.5; }
        .btn-plus { background: var(--bosch-light-blue); }
        .btn-minus { background: var(--bosch-blue); }
        .btn-wp { background: var(--bosch-red); font-size: 10px; width: 38px; }

        .logout-timer { font-size: 12px; font-weight: bold; color: #666; display: none; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 20px; border-radius: 4px; z-index: 6000; display: none; }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <div id="pptOverlay" class="ppt-overlay">
        <div class="ppt-slide active" id="slide1">
            <div class="ppt-header">Dashboard Berechnung</div>
            <div class="ppt-content">
                <ul>
                    <li><b>Ist-Wert:</b> Rohe StÃ¼ckzahl minus WP-Offset.</li>
                    <li><b>Soll-Wert:</b> 16.000er Schritte basierend auf Zyklen.</li>
                    <li><b>Rest:</b> Die Differenz (BalkenhÃ¶he).</li>
                </ul>
            </div>
        </div>
        <div class="ppt-slide" id="slide2">
            <div class="ppt-header">Sicherheits-Konzept</div>
            <div class="ppt-content">
                <ul>
                    <li><b>Admin-PW:</b> In Firebase (adminConfig) hinterlegt.</li>
                    <li><b>Auto-Logout:</b> InaktivitÃ¤tsschutz nach 20 Sekunden.</li>
                    <li><b>Einladungscode:</b> bosch2026 fÃ¼r neue User.</li>
                </ul>
            </div>
        </div>
        <div class="ppt-nav">
            <button class="nav-btn" onclick="changeSlide(-1)">ZurÃ¼ck</button>
            <button class="nav-btn btn-primary" onclick="changeSlide(1)">Weiter</button>
            <button class="nav-btn" onclick="closePPT()">SchlieÃŸen</button>
        </div>
    </div>

    <div class="top-bar"></div>
    <div class="header">
        <div class="bosch-brand">BOSCH<span> AGIE</span></div>
        <div id="logoutDisplay" class="logout-timer">Logout: <span id="secondsLeft">20</span>s</div>
    </div>

    <div class="action-bar">
        <button id="btnLogin" class="nav-btn" onclick="showAuth()">ðŸ”‘ Anmelden</button>
        <button class="nav-btn btn-primary" onclick="alert('Import...')">ðŸ“¥ Import</button>
    </div>

    <div class="main-layout">
        <div class="content-area">
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
                <button id="btnShowPresentation" onclick="openPPT()">ðŸ“Š System-Hilfe</button>
            </div>
        </div>
        <div class="sidebar" id="listContainer"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg",
            authDomain: "bosch-agie-wartung.firebaseapp.com",
            databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bosch-agie-wartung",
            storageBucket: "bosch-agie-wartung.firebasestorage.app",
            messagingSenderId: "211606405555",
            appId: "1:211606405555:web:cc2475ca47804086a3cbc6"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let localState = { cloudRawData: [], extraCycles: {}, agieOffsets: {} };
        let chartInstance = null, logoutTimer = null, currentSlide = 1;

        function refreshUI() {
            const isLogged = !!auth.currentUser;
            const data = localState.cloudRawData.map(item => {
                const id = item.StationNo;
                const ist = (parseInt(item.Parts) || 0) - (localState.agieOffsets[id] || 0);
                const cycles = localState.extraCycles[id] || 0;
                const target = 16000 + (cycles * 16000);
                const diff = target - ist;
                const color = diff < 0 ? "#b00000" : (diff < 500 ? "#d50000" : (diff < 5000 ? "#ffcf00" : "#008a4f"));
                return { id, diff, ist, cycles, color, target };
            }).sort((a,b) => a.diff - b.diff);

            renderChart(data);
            renderList(data, isLogged);
            
            // WICHTIG: Button nur zeigen wenn eingeloggt
            document.getElementById('btnShowPresentation').style.display = isLogged ? 'block' : 'none';
        }

        function renderChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => "A"+d.id),
                    datasets: [{ 
                        data: data.map(d => d.diff), 
                        backgroundColor: data.map(d => d.color),
                        istData: data.map(d => d.ist),
                        targetData: data.map(d => d.target)
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => [
                                    `ReststÃ¼cke: ${ctx.parsed.y.toLocaleString()}`,
                                    `Ist-Wert: ${ctx.dataset.istData[ctx.dataIndex].toLocaleString()}`,
                                    `Soll-Wert: ${ctx.dataset.targetData[ctx.dataIndex].toLocaleString()}`
                                ]
                            }
                        }
                    }
                }
            });
        }

        function renderList(data, isLogged) {
            let html = '';
            data.forEach(d => {
                html += `<div class="control-row">
                    <div style="flex:1"><b>A${d.id}</b></div>
                    <div style="flex:1; text-align:right"><b>${d.diff.toLocaleString()}</b></div>
                    <button class="btn-icon btn-wp" ${isLogged && d.ist >= 215500 ? '' : 'disabled'}>WP</button>
                    <button class="btn-icon btn-minus" ${isLogged ? '' : 'disabled'}>-</button>
                    <div style="width:20px; text-align:center">${d.cycles}</div>
                    <button class="btn-icon btn-plus" ${isLogged && d.diff <= 5000 ? '' : 'disabled'}>+</button>
                </div>`;
            });
            document.getElementById('listContainer').innerHTML = html;
        }

        // AUTH
        auth.onAuthStateChanged(user => {
            document.getElementById('btnLogin').innerHTML = user ? "ðŸ”“ Logout" : "ðŸ”‘ Login";
            refreshUI();
            if(user) startTimer(); else stopTimer();
        });

        function showAuth() {
            if(auth.currentUser) { auth.signOut(); return; }
            const e = prompt("Email:"), p = prompt("PW:");
            if(e && p) auth.signInWithEmailAndPassword(e, p);
        }

        // PPT LOGIC
        function openPPT() { 
            document.getElementById('pptOverlay').style.display = "flex"; 
            currentSlide = 1; 
            updateSlides(); 
        }
        function closePPT() { document.getElementById('pptOverlay').style.display = "none"; }
        function changeSlide(n) { 
            currentSlide += n; 
            if(currentSlide < 1) currentSlide = 1; 
            if(currentSlide > 2) currentSlide = 2; 
            updateSlides(); 
        }
        function updateSlides() {
            document.querySelectorAll('.ppt-slide').forEach((s, i) => s.classList.toggle('active', (i+1) === currentSlide));
        }

        // TIMER & DATA
        function startTimer() { document.getElementById('logoutDisplay').style.display = "block"; }
        function stopTimer() { document.getElementById('logoutDisplay').style.display = "none"; }
        
        db.ref('maintenanceState').on('value', snap => {
            const v = snap.val();
            if (v) {
                localState.cloudRawData = v.cloudRawData || [];
                localState.extraCycles = v.extraCycles || {};
                localState.agieOffsets = v.agieOffsets || {};
                refreshUI();
            }
        });
    </script>
</body>
</html>
